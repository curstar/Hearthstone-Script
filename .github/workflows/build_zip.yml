name: 编译炉石脚本 (Java 25)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. 下载代码（递归下载所有子仓库）
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 2. 强制将子仓库更新到你修改后的最新状态
    - name: Force Update Submodules
      run: |
        git submodule sync
        git submodule update --init --recursive --remote

    # 3. 配置 Java 25 环境 (按你的要求)
    # 如果运行报错说找不到 Temurin 的 25 版本，请把 distribution 改为 'zulu' 或 'oracle'
    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin' 
        cache: 'maven'

    # 4. 编译整个项目
    # -Dmaven.test.skip=true: 跳过测试
    # -Dmaven.javadoc.skip=true: 跳过文档生成
    - name: Build All Modules
      run: mvn -B package --file pom.xml -Dmaven.test.skip=true -Dmaven.javadoc.skip=true

    # 5. 整理文件，准备打包
    # 将 hs-script-app 里的主程序 jar 包和 static 文件夹提取出来
    - name: Prepare Release Folder
      run: |
        mkdir release_package
        
        # 1. 找到主程序 (排除 source 和 original 包)
        find hs-script-app/target -name "*.jar" ! -name "*original*" ! -name "*sources*" -exec cp {} release_package/ \;
        
        # 2. 复制 static 文件夹 (如果有)
        if [ -d "static" ]; then cp -r static release_package/static; fi
        
        # 3. 复制 tools 文件夹 (如果有)
        if [ -d "tools" ]; then cp -r tools release_package/tools; fi

    # 6. 上传最终打包好的 ZIP
    - name: Upload Release
      uses: actions/upload-artifact@v4
      with:
        name: Hearthstone-Script-Java25-Release
        path: release_package/
